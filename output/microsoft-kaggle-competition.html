
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/font-awesome.min.css">







<meta name="author" content="Chan Jin Hao" />
<meta name="description" content="This is the write up for my solution for the Microsoft Malware Prediction https://www.kaggle.com/c/microsoft-malware-prediction I got pretty high up the leader board, but it was nothing that I was proud of, because: I grossly overfitted my model The final result was a blend of another …" />
<meta name="keywords" content="Kaggle">

<meta property="og:site_name" content="glob"/>
<meta property="og:title" content="Microsoft Kaggle Competition"/>
<meta property="og:description" content="This is the write up for my solution for the Microsoft Malware Prediction https://www.kaggle.com/c/microsoft-malware-prediction I got pretty high up the leader board, but it was nothing that I was proud of, because: I grossly overfitted my model The final result was a blend of another …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/microsoft-kaggle-competition.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-03-31 09:38:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/chan-jin-hao.html">
<meta property="article:section" content="Data Science"/>
<meta property="article:tag" content="Kaggle"/>
<meta property="og:image" content="">

  <title>glob &ndash; Microsoft Kaggle Competition</title>

</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href=""></a></h1>


      <nav>
        <ul class="list">

          <li><a href="/">All</a></li>
          <li><a href="/category/data-science.html">Data Science</a></li>
          <li><a href="/category/security.html">Cyber Security</a></li>
          <li><a href="/category/software-engineering.html">Software Engineering</a></li>
          <li><a href="/category/review.html">Book Reviews</a></li>
          <li><a href="/category/ramblings.html">Ramblings</a></li>
        </ul>
      </nav>

		<p>What the osfork? Just like the pythonic way of spawning off different processes by invoking <p style="font-family:courier;">os.fork</p> this website is meant to have different processes of content.</p>
		<p>From technical stuff, to books I've read, and ramblings about life, all my thought processes are here.</p>
      <br/>
      <br/>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/jin-hao-chan-162630120/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://www.github.com/jinhaochan" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>

    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="microsoft-kaggle-competition">Microsoft Kaggle Competition</h1>
    <p>
          Posted on Sun 31 March 2019 in <a href="/category/data-science.html">Data Science</a>


    </p>
  </header>


  <div>
    <p>This is the write up for my solution for the Microsoft Malware Prediction</p>
<p><a href="https://www.kaggle.com/c/microsoft-malware-prediction">https://www.kaggle.com/c/microsoft-malware-prediction</a></p>
<p>I got pretty high up the leader board, but it was nothing that I was proud of, because:</p>
<!-- wp:list {"ordered":true} -->

<ol>
<li>I grossly overfitted my model</li>
<li>The final result was a blend of another kernel</li>
<li>All my attempts at feature engineering failed</li>
</ol>
<p>And I'm now officially ceasing efforts to improve my score, because:</p>
<!-- wp:list {"ordered":true} -->

<ol>
<li>I'm not learning anything new, just mindlessly tweaking hyperparameters and hoping one of them works</li>
<li>I don't think I've got the basics down yet, and this challenge was way over my head. I feel I should start with something simpler</li>
<li>And most importantly, I'm no longer having fun</li>
</ol>
<p>But wait! Doing such a hard competition really taught me many concepts, such as:</p>
<!-- wp:list {"ordered":true} -->

<ol>
<li>Adversarial Cross Validation</li>
<li>How to properly use LightGBM</li>
<li>The real problem of overfitting, which LightGBM does really fast</li>
<li>Blending and Ensembling is a powerful method for getting good results</li>
</ol>
<p>Below shows one of the code variants I've used. They were all mostly the same, with a few hyperparameters being different, and some failed attempts at feature engineering.</p>
<p>The most important features were Version numbers, and there's probably some way to exploit that.</p>
<p>My single model (which I believe grossly overfitted, because I set <code>num_leaves=8000</code> got me a score of 0.684. I blended with another blended kernel of 0.688, and my final score was 0.692.</p>
<p>I think this got me off at the wrong start because I was working and tweaking with those overfitted hyperparameters, when they were wrong in the first place.</p>
<p>Anyway, on to the next competition!  </p>
<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="c1"># This Python 3 environment comes with many helpful analytics libraries installed</span>
<span class="c1"># It is defined by the kaggle/python docker image: https://github.com/kaggle/docker-python</span>
<span class="c1"># For example, here&#39;s several helpful packages to load in </span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">category_encoders</span> <span class="k">as</span> <span class="nn">ce</span>

<span class="n">le</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span>


<span class="c1"># Any results you write to the current directory are saved as output.</span>

<span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">#&#39;MachineIdentifier&#39;:                                    &#39;category&#39;,</span>
        <span class="s1">&#39;ProductName&#39;</span><span class="p">:</span>                                          <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;EngineVersion&#39;</span><span class="p">:</span>                                        <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AppVersion&#39;</span><span class="p">:</span>                                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AvSigVersion&#39;</span><span class="p">:</span>                                         <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IsBeta&#39;</span><span class="p">:</span>                                               <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;RtpStateBitfield&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IsSxsPassiveMode&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DefaultBrowsersIdentifier&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AVProductStatesIdentifier&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AVProductsInstalled&#39;</span><span class="p">:</span>                                  <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AVProductsEnabled&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HasTpm&#39;</span><span class="p">:</span>                                               <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CountryIdentifier&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CityIdentifier&#39;</span><span class="p">:</span>                                       <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OrganizationIdentifier&#39;</span><span class="p">:</span>                               <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GeoNameIdentifier&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LocaleEnglishNameIdentifier&#39;</span><span class="p">:</span>                          <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Platform&#39;</span><span class="p">:</span>                                             <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Processor&#39;</span><span class="p">:</span>                                            <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsVer&#39;</span><span class="p">:</span>                                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsBuild&#39;</span><span class="p">:</span>                                              <span class="s1">&#39;int16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsSuite&#39;</span><span class="p">:</span>                                              <span class="s1">&#39;int16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsPlatformSubRelease&#39;</span><span class="p">:</span>                                 <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsBuildLab&#39;</span><span class="p">:</span>                                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SkuEdition&#39;</span><span class="p">:</span>                                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IsProtected&#39;</span><span class="p">:</span>                                          <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AutoSampleOptIn&#39;</span><span class="p">:</span>                                      <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PuaMode&#39;</span><span class="p">:</span>                                              <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SMode&#39;</span><span class="p">:</span>                                                <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IeVerIdentifier&#39;</span><span class="p">:</span>                                      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SmartScreen&#39;</span><span class="p">:</span>                                          <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Firewall&#39;</span><span class="p">:</span>                                             <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UacLuaenable&#39;</span><span class="p">:</span>                                         <span class="s1">&#39;float64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_MDC2FormFactor&#39;</span><span class="p">:</span>                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_DeviceFamily&#39;</span><span class="p">:</span>                                  <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OEMNameIdentifier&#39;</span><span class="p">:</span>                             <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OEMModelIdentifier&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorCoreCount&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorManufacturerIdentifier&#39;</span><span class="p">:</span>               <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorModelIdentifier&#39;</span><span class="p">:</span>                      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorClass&#39;</span><span class="p">:</span>                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_PrimaryDiskTotalCapacity&#39;</span><span class="p">:</span>                      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_PrimaryDiskTypeName&#39;</span><span class="p">:</span>                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_SystemVolumeTotalCapacity&#39;</span><span class="p">:</span>                     <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_HasOpticalDiskDrive&#39;</span><span class="p">:</span>                           <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_TotalPhysicalRAM&#39;</span><span class="p">:</span>                              <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ChassisTypeName&#39;</span><span class="p">:</span>                               <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalPrimaryDiagonalDisplaySizeInInches&#39;</span><span class="p">:</span>    <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalPrimaryDisplayResolutionHorizontal&#39;</span><span class="p">:</span>    <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalPrimaryDisplayResolutionVertical&#39;</span><span class="p">:</span>      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_PowerPlatformRoleName&#39;</span><span class="p">:</span>                         <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalBatteryType&#39;</span><span class="p">:</span>                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalBatteryNumberOfCharges&#39;</span><span class="p">:</span>                <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSVersion&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSArchitecture&#39;</span><span class="p">:</span>                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSBranch&#39;</span><span class="p">:</span>                                      <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSBuildNumber&#39;</span><span class="p">:</span>                                 <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSBuildRevision&#39;</span><span class="p">:</span>                               <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSEdition&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSSkuName&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSInstallTypeName&#39;</span><span class="p">:</span>                             <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSInstallLanguageIdentifier&#39;</span><span class="p">:</span>                   <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSUILocaleIdentifier&#39;</span><span class="p">:</span>                          <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSWUAutoUpdateOptionsName&#39;</span><span class="p">:</span>                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsPortableOperatingSystem&#39;</span><span class="p">:</span>                     <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_GenuineStateName&#39;</span><span class="p">:</span>                              <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ActivationChannel&#39;</span><span class="p">:</span>                             <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsFlightingInternal&#39;</span><span class="p">:</span>                           <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsFlightsDisabled&#39;</span><span class="p">:</span>                             <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_FlightRing&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ThresholdOptIn&#39;</span><span class="p">:</span>                                <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_FirmwareManufacturerIdentifier&#39;</span><span class="p">:</span>                <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_FirmwareVersionIdentifier&#39;</span><span class="p">:</span>                     <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsSecureBootEnabled&#39;</span><span class="p">:</span>                           <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsWIMBootEnabled&#39;</span><span class="p">:</span>                              <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsVirtualDevice&#39;</span><span class="p">:</span>                               <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsTouchEnabled&#39;</span><span class="p">:</span>                                <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsPenCapable&#39;</span><span class="p">:</span>                                  <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsAlwaysOnAlwaysConnectedCapable&#39;</span><span class="p">:</span>              <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Wdft_IsGamer&#39;</span><span class="p">:</span>                                         <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Wdft_RegionIdentifier&#39;</span><span class="p">:</span>                                <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HasDetections&#39;</span><span class="p">:</span>                                        <span class="s1">&#39;int8&#39;</span>
    <span class="p">}</span>


<span class="c1"># read data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading Data&quot;</span><span class="p">)</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sorted.csv&#39;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">5000000</span><span class="p">,</span> <span class="kp">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MachineIdentifier&#39;</span><span class="p">)</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="kp">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MachineIdentifier&#39;</span><span class="p">)</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="err">Reading Data</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="nf">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="w"></span>

<span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">f for f in df_train.columns if f != &#39;HasDetections&#39;</span><span class="o">]</span><span class="w"></span>

<span class="n">#assign</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="k">variable</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">y_train</span><span class="w"></span>
<span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="o">[</span><span class="n">&#39;HasDetections&#39;</span><span class="o">]</span><span class="w"></span>
<span class="n">Train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_train</span><span class="o">[</span><span class="n">features</span><span class="o">]</span><span class="w"></span>
<span class="n">Test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df_test</span><span class="o">[</span><span class="n">features</span><span class="o">]</span><span class="w"></span>
</code></pre></div>


<!-- /wp:code -->

<h2>Feature Engineering</h2>
<hr>
<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="n">def</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">series</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">noise_level</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">series</span><span class="p">)))</span>

<span class="n">def</span> <span class="n">target_encode</span><span class="p">(</span><span class="n">trn_series</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> 
                  <span class="n">tst_series</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> 
                  <span class="n">target</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> 
                  <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                  <span class="n">smoothing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">noise_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="ss">&quot;&quot;&quot;</span>
<span class="ss">    Smoothing is computed like in the following paper by Daniele Micci-Barreca</span>
<span class="ss">    https://kaggle2.blob.core.windows.net/forum-message-attachments/225952/7441/high%20cardinality%20categoricals.pdf</span>
<span class="ss">    trn_series : training categorical feature as a pd.Series</span>
<span class="ss">    tst_series : test categorical feature as a pd.Series</span>
<span class="ss">    target : target data as a pd.Series</span>
<span class="ss">    min_samples_leaf (int) : minimum samples to take category average into account</span>
<span class="ss">    smoothing (int) : smoothing effect to balance categorical average vs prior  </span>
<span class="ss">    &quot;&quot;&quot;</span> 
    <span class="n">assert</span> <span class="n">len</span><span class="p">(</span><span class="n">trn_series</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">assert</span> <span class="n">trn_series</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tst_series</span><span class="p">.</span><span class="n">name</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trn_series</span><span class="p">,</span> <span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">#</span> <span class="n">Compute</span> <span class="n">target</span> <span class="n">mean</span> 
    <span class="n">averages</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="k">by</span><span class="o">=</span><span class="n">trn_series</span><span class="p">.</span><span class="n">name</span><span class="p">)[</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">].</span><span class="n">agg</span><span class="p">([</span><span class="ss">&quot;mean&quot;</span><span class="p">,</span> <span class="ss">&quot;count&quot;</span><span class="p">])</span>
    <span class="o">#</span> <span class="n">Compute</span> <span class="n">smoothing</span>
    <span class="n">smoothing</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">averages</span><span class="p">[</span><span class="ss">&quot;count&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_samples_leaf</span><span class="p">)</span> <span class="o">/</span> <span class="n">smoothing</span><span class="p">))</span>
    <span class="o">#</span> <span class="n">Apply</span> <span class="n">average</span> <span class="k">function</span> <span class="k">to</span> <span class="k">all</span> <span class="n">target</span> <span class="k">data</span>
    <span class="k">prior</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="o">#</span> <span class="n">The</span> <span class="n">bigger</span> <span class="n">the</span> <span class="k">count</span> <span class="n">the</span> <span class="k">less</span> <span class="n">full_avg</span> <span class="k">is</span> <span class="n">taken</span> <span class="k">into</span> <span class="n">account</span>
    <span class="n">averages</span><span class="p">[</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">prior</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">smoothing</span><span class="p">)</span> <span class="o">+</span> <span class="n">averages</span><span class="p">[</span><span class="ss">&quot;mean&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">smoothing</span>
    <span class="n">averages</span><span class="p">.</span><span class="k">drop</span><span class="p">([</span><span class="ss">&quot;mean&quot;</span><span class="p">,</span> <span class="ss">&quot;count&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
    <span class="o">#</span> <span class="n">Apply</span> <span class="n">averages</span> <span class="k">to</span> <span class="n">trn</span> <span class="k">and</span> <span class="n">tst</span> <span class="n">series</span>
    <span class="n">ft_trn_series</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">trn_series</span><span class="p">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">trn_series</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
        <span class="n">averages</span><span class="p">.</span><span class="n">reset_index</span><span class="p">().</span><span class="k">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;average&#39;</span><span class="err">}</span><span class="p">),</span>
        <span class="k">on</span><span class="o">=</span><span class="n">trn_series</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)[</span><span class="s1">&#39;average&#39;</span><span class="p">].</span><span class="k">rename</span><span class="p">(</span><span class="n">trn_series</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span><span class="p">).</span><span class="n">fillna</span><span class="p">(</span><span class="k">prior</span><span class="p">)</span>
    <span class="o">#</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span> <span class="n">does</span> <span class="k">not</span> <span class="n">keep</span> <span class="n">the</span> <span class="k">index</span> <span class="n">so</span> <span class="n">restore</span> <span class="n">it</span>
    <span class="n">ft_trn_series</span><span class="p">.</span><span class="k">index</span> <span class="o">=</span> <span class="n">trn_series</span><span class="p">.</span><span class="k">index</span> 
    <span class="n">ft_tst_series</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">tst_series</span><span class="p">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">tst_series</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
        <span class="n">averages</span><span class="p">.</span><span class="n">reset_index</span><span class="p">().</span><span class="k">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;average&#39;</span><span class="err">}</span><span class="p">),</span>
        <span class="k">on</span><span class="o">=</span><span class="n">tst_series</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)[</span><span class="s1">&#39;average&#39;</span><span class="p">].</span><span class="k">rename</span><span class="p">(</span><span class="n">trn_series</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span><span class="p">).</span><span class="n">fillna</span><span class="p">(</span><span class="k">prior</span><span class="p">)</span>
    <span class="o">#</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span> <span class="n">does</span> <span class="k">not</span> <span class="n">keep</span> <span class="n">the</span> <span class="k">index</span> <span class="n">so</span> <span class="n">restore</span> <span class="n">it</span>
    <span class="n">ft_tst_series</span><span class="p">.</span><span class="k">index</span> <span class="o">=</span> <span class="n">tst_series</span><span class="p">.</span><span class="k">index</span>
    <span class="k">return</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">ft_trn_series</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">),</span> <span class="n">add_noise</span><span class="p">(</span><span class="n">ft_tst_series</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">)</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">combine</span><span class="w"> </span><span class="n">dtrain</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">dtest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">preprocessing</span><span class="w"></span>
<span class="n">alldata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="o">[</span><span class="n">Train,Test</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>

<span class="n">trainlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">Train</span><span class="p">)</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="nf">convert</span><span class="w"> </span><span class="k">character</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">integer</span><span class="w"></span>
<span class="k">print</span><span class="p">(</span><span class="ss">&quot;Label Encoding&quot;</span><span class="p">)</span><span class="w"></span>
<span class="nc">numeric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Train</span><span class="p">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="k">include</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">number</span><span class="p">).</span><span class="n">columns</span><span class="p">.</span><span class="n">tolist</span><span class="p">()</span><span class="w"></span>
<span class="n">categorical</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">f for f in Train.columns.tolist() if f not in numeric</span><span class="o">]</span><span class="w"></span>
<span class="n">categorical</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">categorical</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="n">alldata</span><span class="o">[</span><span class="n">cat</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">le</span><span class="p">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">alldata</span><span class="o">[</span><span class="n">cat</span><span class="o">]</span><span class="p">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">alldata</span><span class="o">[</span><span class="n">cat</span><span class="o">]</span><span class="p">.</span><span class="n">mode</span><span class="p">().</span><span class="n">iloc</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">))</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">dtrain</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">dtest</span><span class="w"></span>
<span class="n">Train</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alldata</span><span class="o">[</span><span class="n">:trainlen</span><span class="o">]</span><span class="w"></span>
<span class="n">Test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alldata</span><span class="o">[</span><span class="n">trainlen:</span><span class="o">]</span><span class="w"></span>
</code></pre></div>


<!-- /wp:code -->

<h2>Training</h2>
<hr>
<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="n">params</span> <span class="o">=</span> <span class="err">{</span>
    <span class="s1">&#39;boosting_type&#39;</span> <span class="p">:</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;objective&#39;</span> <span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="s1">&#39;metric&#39;</span> <span class="p">:</span> <span class="s1">&#39;binary_logloss&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;nthread&#39;</span> <span class="p">:</span> <span class="mi">16</span><span class="p">,</span> 
    <span class="s1">&#39;learning_rate&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="p">,</span>
    <span class="s1">&#39;max_depth&#39;</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;num_leaves&#39;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;sub_feature&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">,</span> 
    <span class="s1">&#39;sub_row&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">,</span> 
    <span class="s1">&#39;bagging_freq&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;bagging_fraction&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;lambda_l1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> 
    <span class="s1">&#39;lambda_l2&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">2</span>
<span class="err">}</span>

<span class="n">def</span> <span class="n">modeling_cross_validation</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">folds</span><span class="p">):</span>
    <span class="n">clfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">allPreds</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">evals_result</span> <span class="o">=</span> <span class="err">{}</span>

    <span class="n">X_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X_len</span><span class="p">:]</span>
    <span class="n">X_valid</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">X_len</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">X_len</span><span class="p">:]</span>
    <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">X_len</span><span class="p">]</span> 

    <span class="n">lgb_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">lgb_valid</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">lgb_train</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                <span class="n">lgb_train</span><span class="p">,</span>
                <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                <span class="n">valid_sets</span><span class="o">=</span><span class="p">[</span><span class="n">lgb_train</span><span class="p">,</span> <span class="n">lgb_valid</span><span class="p">],</span>
                <span class="n">evals_result</span><span class="o">=</span><span class="n">evals_result</span><span class="p">,</span>
                <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;Plot metrics during training...&#39;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="n">plot_metric</span><span class="p">(</span><span class="n">evals_result</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;binary_logloss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="k">show</span><span class="p">()</span>

    <span class="n">print</span><span class="p">(</span><span class="s1">&#39;Plot feature importances...&#39;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">lgb</span><span class="p">.</span><span class="n">plot_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">max_num_features</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="k">show</span><span class="p">()</span>

    <span class="s1">&#39;&#39;&#39;</span>

<span class="s1">    allPreds = model.predict(X_test)</span>

<span class="s1">    score = roc_auc_score(y_test, allPreds)</span>
<span class="s1">    print(score)</span>
<span class="s1">    &#39;&#39;&#39;</span>

    <span class="n">clfs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clfs</span>


<span class="n">def</span> <span class="n">predict_cross_validation</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">clfs</span><span class="p">):</span>

    <span class="n">sub_preds</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="k">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">clfs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>    
        <span class="n">test_preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="n">sub_preds</span> <span class="o">+=</span> <span class="n">test_preds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="o">#</span> <span class="n">Averaging</span> <span class="n">across</span> <span class="k">all</span> <span class="n">models</span>
    <span class="n">sub_preds</span> <span class="o">=</span> <span class="n">sub_preds</span> <span class="o">/</span> <span class="n">len</span><span class="p">(</span><span class="n">clfs</span><span class="p">)</span>

    <span class="o">#</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">series</span> <span class="k">from</span> <span class="n">the</span> <span class="n">predictions</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sub_preds</span><span class="p">,</span> <span class="k">index</span><span class="o">=</span><span class="n">test</span><span class="p">.</span><span class="k">index</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">.</span><span class="k">index</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="k">index</span><span class="p">.</span><span class="n">name</span> 

    <span class="k">return</span> <span class="n">ret</span>

<span class="n">def</span> <span class="n">predict_test_chunk</span><span class="p">(</span><span class="n">clfs</span><span class="p">,</span> <span class="n">Test</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;tmp.csv&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>

    <span class="n">preds_sub</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">7853253</span><span class="o">/</span><span class="mi">100000</span><span class="p">)</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="n">Test</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">Test</span><span class="p">))</span><span class="o">//</span><span class="n">chunks</span><span class="p">)</span>

    <span class="k">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">df</span> <span class="k">in</span> <span class="n">groups</span><span class="p">:</span>

        <span class="k">if</span> <span class="k">count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">print</span><span class="p">(</span><span class="ss">&quot;Running on idx {} of {}&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
            <span class="k">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">preds_df</span> <span class="o">=</span> <span class="n">predict_cross_validation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clfs</span><span class="p">)</span>
        <span class="n">preds_df</span> <span class="o">=</span> <span class="n">preds_df</span><span class="p">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;HasDetections&#39;</span><span class="p">)</span>

        <span class="n">preds_sub</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">preds_sub</span><span class="p">,</span> <span class="n">preds_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">del</span> <span class="n">preds_df</span>
        <span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">preds_sub</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="err">print(&quot;Start Training&quot;)</span>
<span class="err">clfs = modeling_cross_validation(params, Train, y, 3)</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="err">Start Training</span>
<span class="err">Training until validation scores don&#39;t improve for 50 rounds.</span>
<span class="err">[100]    training&#39;s binary_logloss: 0.626603 valid_1&#39;s binary_logloss: 0.632894</span>
<span class="err">[200]    training&#39;s binary_logloss: 0.614641 valid_1&#39;s binary_logloss: 0.624013</span>
<span class="err">Did not meet early stopping. Best iteration is:</span>
<span class="err">[200]    training&#39;s binary_logloss: 0.614641 valid_1&#39;s binary_logloss: 0.624013</span>
<span class="err">Plot metrics during training...</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="err">Plot feature importances...</span>
</code></pre></div>


<!-- /wp:code -->

<!-- wp:image {"id":241} -->

<p><img alt="placeholder" class="wp-image-241" src="/media/2019/01/output_9_1.png"></p>
<!-- wp:image {"id":242} -->

<p><img alt="placeholder" class="wp-image-242" src="/media/2019/01/output_9_3.png"></p>
<!-- wp:code -->

<div class="highlight"><pre><span></span><code><span class="n">print</span><span class="p">(</span><span class="ss">&quot;Start Predicting&quot;</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">predict_test_chunk</span><span class="p">(</span><span class="n">clfs</span><span class="p">,</span> <span class="n">Test</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>

<span class="n">print</span><span class="p">(</span><span class="ss">&quot;Start Submission&quot;</span><span class="p">)</span>
<span class="n">df_sub</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sample_submission.csv&#39;</span><span class="p">)</span>
<span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;HasDetections&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;HasDetections&#39;</span><span class="p">].</span><span class="k">values</span>
<span class="n">df_sub</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;mySubmission.csv&#39;</span><span class="p">,</span> <span class="k">index</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>

<span class="n">print</span><span class="p">(</span><span class="ss">&quot;Done!&quot;</span><span class="p">)</span>
</code></pre></div>


<!-- /wp:code -->
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/kaggle.html">Kaggle</a>
    </p>
  </div>





  <section id="comments" class="body">
	  <h2>Comments:</h2>
	  Contact me for any comments, and I'll paste them here! Why not Disqus or other comment services? That's because I want to have control of my site, comments included!

	  PS: I won't put your real name and email if you don't want me to.
	  
  </section>

</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " glob ",
  "url" : "",
  "image": "",
  "description": ""
}
</script>

</body>
</html>
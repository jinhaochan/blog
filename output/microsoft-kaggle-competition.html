
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/font-awesome.min.css">







<meta name="author" content="Chan Jin Hao" />
<meta name="description" content="This is the write up for my solution for the Microsoft Malware Prediction https://www.kaggle.com/c/microsoft-malware-prediction I got pretty high up the leader board, but it was nothing that I was proud of, because: I grossly overfitted my model The final result was a blend of another …" />
<meta name="keywords" content="Kaggle">

<meta property="og:site_name" content="glob"/>
<meta property="og:title" content="Microsoft Kaggle Competition"/>
<meta property="og:description" content="This is the write up for my solution for the Microsoft Malware Prediction https://www.kaggle.com/c/microsoft-malware-prediction I got pretty high up the leader board, but it was nothing that I was proud of, because: I grossly overfitted my model The final result was a blend of another …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/microsoft-kaggle-competition.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-03-31 09:38:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/chan-jin-hao.html">
<meta property="article:section" content="Data Science"/>
<meta property="article:tag" content="Kaggle"/>
<meta property="og:image" content="">

  <title>glob &ndash; Microsoft Kaggle Competition</title>

</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href=""></a></h1>


      <nav>
        <ul class="list">

          <li><a href="/">All</a></li>
          <li><a href="/category/data-science.html">Data Science</a></li>
          <li><a href="/category/security.html">Cyber Security</a></li>
          <li><a href="/category/software-engineering.html">Software Engineering</a></li>
          <li><a href="/category/review.html">Book Reviews</a></li>
          <li><a href="/category/ramblings.html">Ramblings</a></li>
        </ul>
      </nav>

		<p>What the osfork? Just like the pythonic way of spawning off different processes by invoking <p style="font-family:courier;">os.fork</p> this website is meant to have different processes of content.</p>
		<p>From technical stuff, to books I've read, and ramblings about life, all my thought processes are here.</p>
      <br/>
      <br/>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/jinhao-hao-chan-162630120/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://www.github.com/jinhaochan" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>

    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="microsoft-kaggle-competition">Microsoft Kaggle Competition</h1>
    <p>
          Posted on Sun 31 March 2019 in <a href="/category/data-science.html">Data Science</a>


    </p>
  </header>


  <div>
    <p>This is the write up for my solution for the Microsoft Malware Prediction</p>
<p><a href="https://www.kaggle.com/c/microsoft-malware-prediction">https://www.kaggle.com/c/microsoft-malware-prediction</a></p>
<p>I got pretty high up the leader board, but it was nothing that I was proud of, because:</p>
<!-- wp:list {"ordered":true} -->

<ol>
<li>I grossly overfitted my model</li>
<li>The final result was a blend of another kernel</li>
<li>All my attempts at feature engineering failed</li>
</ol>
<p>And I'm now officially ceasing efforts to improve my score, because:</p>
<!-- wp:list {"ordered":true} -->

<ol>
<li>I'm not learning anything new, just mindlessly tweaking hyperparameters and hoping one of them works</li>
<li>I don't think I've got the basics down yet, and this challenge was way over my head. I feel I should start with something simpler</li>
<li>And most importantly, I'm no longer having fun</li>
</ol>
<p>But wait! Doing such a hard competition really taught me many concepts, such as:</p>
<!-- wp:list {"ordered":true} -->

<ol>
<li>Adversarial Cross Validation</li>
<li>How to properly use LightGBM</li>
<li>The real problem of overfitting, which LightGBM does really fast</li>
<li>Blending and Ensembling is a powerful method for getting good results</li>
</ol>
<p>Below shows one of the code variants I've used. They were all mostly the same, with a few hyperparameters being different, and some failed attempts at feature engineering.</p>
<p>The most important features were Version numbers, and there's probably some way to exploit that.</p>
<p>My single model (which I believe grossly overfitted, because I set <code>num_leaves=8000</code> got me a score of 0.684. I blended with another blended kernel of 0.688, and my final score was 0.692.</p>
<p>I think this got me off at the wrong start because I was working and tweaking with those overfitted hyperparameters, when they were wrong in the first place.</p>
<p>Anyway, on to the next competition!  </p>
<!-- wp:code -->

<div class="highlight"><pre><span></span><span class="c1"># This Python 3 environment comes with many helpful analytics libraries installed</span>
<span class="c1"># It is defined by the kaggle/python docker image: https://github.com/kaggle/docker-python</span>
<span class="c1"># For example, here&#39;s several helpful packages to load in </span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="kn">as</span> <span class="nn">lgb</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">category_encoders</span> <span class="kn">as</span> <span class="nn">ce</span>

<span class="n">le</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span>


<span class="c1"># Any results you write to the current directory are saved as output.</span>

<span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">#&#39;MachineIdentifier&#39;:                                    &#39;category&#39;,</span>
        <span class="s1">&#39;ProductName&#39;</span><span class="p">:</span>                                          <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;EngineVersion&#39;</span><span class="p">:</span>                                        <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AppVersion&#39;</span><span class="p">:</span>                                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AvSigVersion&#39;</span><span class="p">:</span>                                         <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IsBeta&#39;</span><span class="p">:</span>                                               <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;RtpStateBitfield&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IsSxsPassiveMode&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DefaultBrowsersIdentifier&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AVProductStatesIdentifier&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AVProductsInstalled&#39;</span><span class="p">:</span>                                  <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AVProductsEnabled&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HasTpm&#39;</span><span class="p">:</span>                                               <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CountryIdentifier&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CityIdentifier&#39;</span><span class="p">:</span>                                       <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OrganizationIdentifier&#39;</span><span class="p">:</span>                               <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GeoNameIdentifier&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LocaleEnglishNameIdentifier&#39;</span><span class="p">:</span>                          <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Platform&#39;</span><span class="p">:</span>                                             <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Processor&#39;</span><span class="p">:</span>                                            <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsVer&#39;</span><span class="p">:</span>                                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsBuild&#39;</span><span class="p">:</span>                                              <span class="s1">&#39;int16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsSuite&#39;</span><span class="p">:</span>                                              <span class="s1">&#39;int16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsPlatformSubRelease&#39;</span><span class="p">:</span>                                 <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OsBuildLab&#39;</span><span class="p">:</span>                                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SkuEdition&#39;</span><span class="p">:</span>                                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IsProtected&#39;</span><span class="p">:</span>                                          <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AutoSampleOptIn&#39;</span><span class="p">:</span>                                      <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PuaMode&#39;</span><span class="p">:</span>                                              <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SMode&#39;</span><span class="p">:</span>                                                <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IeVerIdentifier&#39;</span><span class="p">:</span>                                      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SmartScreen&#39;</span><span class="p">:</span>                                          <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Firewall&#39;</span><span class="p">:</span>                                             <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UacLuaenable&#39;</span><span class="p">:</span>                                         <span class="s1">&#39;float64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_MDC2FormFactor&#39;</span><span class="p">:</span>                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_DeviceFamily&#39;</span><span class="p">:</span>                                  <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OEMNameIdentifier&#39;</span><span class="p">:</span>                             <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OEMModelIdentifier&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorCoreCount&#39;</span><span class="p">:</span>                            <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorManufacturerIdentifier&#39;</span><span class="p">:</span>               <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorModelIdentifier&#39;</span><span class="p">:</span>                      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ProcessorClass&#39;</span><span class="p">:</span>                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_PrimaryDiskTotalCapacity&#39;</span><span class="p">:</span>                      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_PrimaryDiskTypeName&#39;</span><span class="p">:</span>                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_SystemVolumeTotalCapacity&#39;</span><span class="p">:</span>                     <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_HasOpticalDiskDrive&#39;</span><span class="p">:</span>                           <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_TotalPhysicalRAM&#39;</span><span class="p">:</span>                              <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ChassisTypeName&#39;</span><span class="p">:</span>                               <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalPrimaryDiagonalDisplaySizeInInches&#39;</span><span class="p">:</span>    <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalPrimaryDisplayResolutionHorizontal&#39;</span><span class="p">:</span>    <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalPrimaryDisplayResolutionVertical&#39;</span><span class="p">:</span>      <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_PowerPlatformRoleName&#39;</span><span class="p">:</span>                         <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalBatteryType&#39;</span><span class="p">:</span>                           <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_InternalBatteryNumberOfCharges&#39;</span><span class="p">:</span>                <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSVersion&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSArchitecture&#39;</span><span class="p">:</span>                                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSBranch&#39;</span><span class="p">:</span>                                      <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSBuildNumber&#39;</span><span class="p">:</span>                                 <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSBuildRevision&#39;</span><span class="p">:</span>                               <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSEdition&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSSkuName&#39;</span><span class="p">:</span>                                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSInstallTypeName&#39;</span><span class="p">:</span>                             <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSInstallLanguageIdentifier&#39;</span><span class="p">:</span>                   <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSUILocaleIdentifier&#39;</span><span class="p">:</span>                          <span class="s1">&#39;int32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_OSWUAutoUpdateOptionsName&#39;</span><span class="p">:</span>                     <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsPortableOperatingSystem&#39;</span><span class="p">:</span>                     <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_GenuineStateName&#39;</span><span class="p">:</span>                              <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ActivationChannel&#39;</span><span class="p">:</span>                             <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsFlightingInternal&#39;</span><span class="p">:</span>                           <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsFlightsDisabled&#39;</span><span class="p">:</span>                             <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_FlightRing&#39;</span><span class="p">:</span>                                    <span class="s1">&#39;category&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_ThresholdOptIn&#39;</span><span class="p">:</span>                                <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_FirmwareManufacturerIdentifier&#39;</span><span class="p">:</span>                <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_FirmwareVersionIdentifier&#39;</span><span class="p">:</span>                     <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsSecureBootEnabled&#39;</span><span class="p">:</span>                           <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsWIMBootEnabled&#39;</span><span class="p">:</span>                              <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsVirtualDevice&#39;</span><span class="p">:</span>                               <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsTouchEnabled&#39;</span><span class="p">:</span>                                <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsPenCapable&#39;</span><span class="p">:</span>                                  <span class="s1">&#39;int8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Census_IsAlwaysOnAlwaysConnectedCapable&#39;</span><span class="p">:</span>              <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Wdft_IsGamer&#39;</span><span class="p">:</span>                                         <span class="s1">&#39;float16&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Wdft_RegionIdentifier&#39;</span><span class="p">:</span>                                <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HasDetections&#39;</span><span class="p">:</span>                                        <span class="s1">&#39;int8&#39;</span>
    <span class="p">}</span>


<span class="c1"># read data</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Reading Data&quot;</span><span class="p">)</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sorted.csv&#39;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">5000000</span><span class="p">,</span> <span class="kp">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MachineIdentifier&#39;</span><span class="p">)</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="kp">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;MachineIdentifier&#39;</span><span class="p">)</span>
</pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span>Reading Data
</pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span>len(df_train)

features = [f for f in df_train.columns if f != &#39;HasDetections&#39;]

#assign target variable to y_train
y = df_train[&#39;HasDetections&#39;]
Train = df_train[features]
Test = df_test[features]
</pre></div>


<!-- /wp:code -->

<h2>Feature Engineering</h2>
<hr>
<!-- wp:code -->

<div class="highlight"><pre><span></span>def add_noise(series, noise_level):
    return series * (1 + noise_level * np.random.randn(len(series)))

def target_encode(trn_series=None, 
                  tst_series=None, 
                  target=None, 
                  min_samples_leaf=1, 
                  smoothing=1,
                  noise_level=0):
    &quot;&quot;&quot;
    Smoothing is computed like in the following paper by Daniele Micci-Barreca
    https://kaggle2.blob.core.windows.net/forum-message-attachments/225952/7441/high%20cardinality%20categoricals.pdf
    trn_series : training categorical feature as a pd.Series
    tst_series : test categorical feature as a pd.Series
    target : target data as a pd.Series
    min_samples_leaf (int) : minimum samples to take category average into account
    smoothing (int) : smoothing effect to balance categorical average vs prior  
    &quot;&quot;&quot; 
    assert len(trn_series) == len(target)
    assert trn_series.name == tst_series.name
    temp = pd.concat([trn_series, target], axis=1)
    # Compute target mean 
    averages = temp.groupby(by=trn_series.name)[target.name].agg([&quot;mean&quot;, &quot;count&quot;])
    # Compute smoothing
    smoothing = 1 / (1 + np.exp(-(averages[&quot;count&quot;] - min_samples_leaf) / smoothing))
    # Apply average function to all target data
    prior = target.mean()
    # The bigger the count the less full_avg is taken into account
    averages[target.name] = prior * (1 - smoothing) + averages[&quot;mean&quot;] * smoothing
    averages.drop([&quot;mean&quot;, &quot;count&quot;], axis=1, inplace=True)
    # Apply averages to trn and tst series
    ft_trn_series = pd.merge(
        trn_series.to_frame(trn_series.name),
        averages.reset_index().rename(columns={&#39;index&#39;: target.name, target.name: &#39;average&#39;}),
        on=trn_series.name,
        how=&#39;left&#39;)[&#39;average&#39;].rename(trn_series.name + &#39;_mean&#39;).fillna(prior)
    # pd.merge does not keep the index so restore it
    ft_trn_series.index = trn_series.index 
    ft_tst_series = pd.merge(
        tst_series.to_frame(tst_series.name),
        averages.reset_index().rename(columns={&#39;index&#39;: target.name, target.name: &#39;average&#39;}),
        on=tst_series.name,
        how=&#39;left&#39;)[&#39;average&#39;].rename(trn_series.name + &#39;_mean&#39;).fillna(prior)
    # pd.merge does not keep the index so restore it
    ft_tst_series.index = tst_series.index
    return add_noise(ft_trn_series, noise_level), add_noise(ft_tst_series, noise_level)
</pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span># combine dtrain and dtest for preprocessing
alldata = pd.concat([Train,Test], axis=0)

trainlen = len(Train)

# convert character columns to integer
print(&quot;Label Encoding&quot;)
numeric = Train.select_dtypes(include=np.number).columns.tolist()
categorical = [f for f in Train.columns.tolist() if f not in numeric]
categorical
for cat in categorical:
    alldata[cat] = le.fit_transform(alldata[cat].fillna(alldata[cat].mode().iloc[0]))

# split back into dtrain and dtest
Train = alldata[:trainlen]
Test = alldata[trainlen:]
</pre></div>


<!-- /wp:code -->

<h2>Training</h2>
<hr>
<!-- wp:code -->

<div class="highlight"><pre><span></span>params = {
    &#39;boosting_type&#39; : &#39;gbdt&#39;, 
    &#39;objective&#39; : &#39;binary&#39;,
    &#39;metric&#39; : &#39;binary_logloss&#39;, 
    &#39;nthread&#39; : 16, 
    &#39;learning_rate&#39; : 0.02,
    &#39;max_depth&#39; : 12,
    &#39;num_leaves&#39; : 100,
    &#39;sub_feature&#39; : 0.7, 
    &#39;sub_row&#39; : 0.7, 
    &#39;bagging_freq&#39; : 1,
    &#39;bagging_fraction&#39; : 0.8,
    &#39;lambda_l1&#39;: 0.1, 
    &#39;lambda_l2&#39; : 0.2
}

def modeling_cross_validation(params, X, y, folds):
    clfs = []
    allPreds = np.zeros(X.shape[0])

    evals_result = {}

    X_len = int(len(X)/3)

    X_train = X[X_len:]
    X_valid = X[:X_len]
    y_train = y[X_len:]
    y_valid = y[:X_len] 

    lgb_train = lgb.Dataset(X_train, y_train)
    lgb_valid = lgb.Dataset(X_valid, y_valid, reference=lgb_train)

    model = lgb.train(params,
                lgb_train,
                num_boost_round=200,
                valid_sets=[lgb_train, lgb_valid],
                evals_result=evals_result,
                verbose_eval=100,
                early_stopping_rounds=50)

    print(&#39;Plot metrics during training...&#39;)
    ax = lgb.plot_metric(evals_result, metric=&#39;binary_logloss&#39;)
    plt.show()

    print(&#39;Plot feature importances...&#39;)
    ax = lgb.plot_importance(model, max_num_features=10)
    plt.show()

    &#39;&#39;&#39;

    allPreds = model.predict(X_test)

    score = roc_auc_score(y_test, allPreds)
    print(score)
    &#39;&#39;&#39;

    clfs.append(model)
    return clfs


def predict_cross_validation(test, clfs):

    sub_preds = np.zeros(test.shape[0])

    for i, model in enumerate(clfs, 1):    
        test_preds = model.predict_proba(test)
        sub_preds += test_preds[:,1]

    # Averaging across all models
    sub_preds = sub_preds / len(clfs)

    # Creating a series from the predictions
    ret = pd.Series(sub_preds, index=test.index)
    ret.index.name = test.index.name 

    return ret

def predict_test_chunk(clfs, Test, filename=&#39;tmp.csv&#39;, chunks=100000):

    preds_sub = pd.DataFrame()

    num = int(7853253/100000)

    groups = Test.groupby(np.arange(len(Test))//chunks)

    count = 0

    for idx, df in groups:

        if count == 10:
            print(&quot;Running on idx {} of {}&quot;.format(idx, num))
            count = 0
        count += 1

        preds_df = predict_cross_validation(df, clfs)
        preds_df = preds_df.to_frame(&#39;HasDetections&#39;)

        preds_sub = pd.concat([preds_sub, preds_df], axis=0)

        del preds_df
        gc.collect()

    return preds_sub
</pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span>print(&quot;Start Training&quot;)
clfs = modeling_cross_validation(params, Train, y, 3)
</pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span>Start Training
Training until validation scores don&#39;t improve for 50 rounds.
[100]    training&#39;s binary_logloss: 0.626603 valid_1&#39;s binary_logloss: 0.632894
[200]    training&#39;s binary_logloss: 0.614641 valid_1&#39;s binary_logloss: 0.624013
Did not meet early stopping. Best iteration is:
[200]    training&#39;s binary_logloss: 0.614641 valid_1&#39;s binary_logloss: 0.624013
Plot metrics during training...
</pre></div>


<!-- /wp:code -->

<!-- wp:code -->

<div class="highlight"><pre><span></span>Plot feature importances...
</pre></div>


<!-- /wp:code -->

<!-- wp:image {"id":241} -->

<p><img alt="placeholder" class="wp-image-241" src="/media/2019/01/output_9_1.png"></p>
<!-- wp:image {"id":242} -->

<p><img alt="placeholder" class="wp-image-242" src="/media/2019/01/output_9_3.png"></p>
<!-- wp:code -->

<div class="highlight"><pre><span></span>print(&quot;Start Predicting&quot;)
preds = predict_test_chunk(clfs, Test, chunks=100000)

print(&quot;Start Submission&quot;)
df_sub = pd.read_csv(&#39;sample_submission.csv&#39;)
df_sub[&#39;HasDetections&#39;] = preds[&#39;HasDetections&#39;].values
df_sub.to_csv(&#39;mySubmission.csv&#39;, index=False)

print(&quot;Done!&quot;)
</pre></div>


<!-- /wp:code -->
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/kaggle.html">Kaggle</a>
    </p>
  </div>





  <section id="comments" class="body">
	  <h2>Comments:</h2>
	  Contact me for any comments, and I'll paste them here! Why not Disqus or other comment services? That's because I want to have control of my site, comments included!

	  PS: I won't put your real name and email if you don't want me to.
	  
  </section>

</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " glob ",
  "url" : "",
  "image": "",
  "description": ""
}
</script>

</body>
</html>